package com.reactnative.googlefit;

import com.facebook.react.bridge.Arguments;
import com.facebook.react.bridge.ReactContext;
import com.facebook.react.bridge.ReadableArray;
import com.facebook.react.bridge.WritableArray;
import com.facebook.react.bridge.WritableMap;

import com.google.android.gms.common.api.GoogleApiClient;
//import com.google.android.gms.fit.samples.common.logger.Log;
import com.google.android.gms.fitness.Fitness;
import com.google.android.gms.fitness.FitnessActivities;
import com.google.android.gms.fitness.data.Bucket;
import com.google.android.gms.fitness.data.DataPoint;
import com.google.android.gms.fitness.data.DataSet;
import com.google.android.gms.fitness.data.DataType;
import com.google.android.gms.fitness.data.Field;
import com.google.android.gms.fitness.request.DataReadRequest;
import com.google.android.gms.fitness.result.DataReadResult;

import java.text.DateFormat;
import java.util.ArrayList;
import java.util.List;
import java.util.concurrent.TimeUnit;

public class QueryAggregator {
    public static final String TAG = "QueryAggregator";

    public static WritableArray getAggregatedDataByDays(GoogleApiClient client, long startTime, long endTime, DataType inputDataType, DataType outputDataType, String valType) {
        DataReadRequest readRequest = queryData(startTime, endTime, inputDataType, outputDataType);
        DataReadResult dataReadResult = Fitness.HistoryApi.readData(client, readRequest).await(1, TimeUnit.MINUTES);

        WritableArray itemMap = Arguments.createArray();
        if (dataReadResult.getBuckets().size() > 0) {
            for (int i=0; i<dataReadResult.getBuckets().size(); i++) {
                Bucket bucket = dataReadResult.getBuckets().get(i);
                handleDataSet(bucket.getDataSets().get(0), itemMap, startTime, i, valType);//data set always one
            }
        }
        return itemMap;
    }

    private static DataReadRequest queryData(long startTime, long endTime, DataType inputDataType, DataType outputDataType) {
        DateFormat dateFormat = DateFormat.getDateInstance();
        DataReadRequest readRequest = new DataReadRequest.Builder()
                .aggregate(inputDataType, outputDataType)
                .bucketByTime(1, TimeUnit.DAYS)
                .setTimeRange(startTime, endTime, TimeUnit.MILLISECONDS)
                .build();
        return readRequest;
    }

    private static void handleDataSet(DataSet dataSet, WritableArray itemMap, long startTime, int bucketInd, String valType) {
        DateFormat dateFormat = DateFormat.getDateInstance();
        DateFormat timeFormat = DateFormat.getTimeInstance();

        WritableMap map = Arguments.createMap();
        map.putDouble("date", Utils.getDefaultTime(startTime, bucketInd));

        int intVal = 0;
        float floatVal = 0;
        for (DataPoint dp : dataSet.getDataPoints()) {
            if (dp.getDataType().equals(DataType.AGGREGATE_ACTIVITY_SUMMARY)) {
                String activity = dp.getValue(Field.FIELD_ACTIVITY).asActivity();
                if (!activity.equals(FitnessActivities.STILL)) {
                    intVal += dp.getValue(Field.FIELD_DURATION).asInt();  
                }
            } else
            if (dp.getDataType().equals(DataType.AGGREGATE_STEP_COUNT_DELTA)) {
                int steps = dp.getValue(Field.FIELD_STEPS).asInt();
                intVal += steps;
            } else
            if (dp.getDataType().equals(DataType.AGGREGATE_DISTANCE_DELTA)) {
                float distance = dp.getValue(Field.FIELD_DISTANCE).asFloat();
                floatVal += distance;
            } else
            if (dp.getDataType().equals(DataType.AGGREGATE_CALORIES_EXPENDED)) {
                float calories = dp.getValue(Field.FIELD_CALORIES).asFloat();
                floatVal += calories;
            }
        }
        
        if (valType.equals("int")) {
            map.putInt("value", intVal);
        } else {
            map.putDouble("value", floatVal);
        }

        /*if (dataSet.getDataPoints().size() == 0) {
            //map.putDouble("date", Utils.getDefaultTime(startTime, bucketInd));
            map.putDouble("value", 0);
        }
        else if (dataSet.getDataPoints().size() == 1) {
            DataPoint dp = dataSet.getDataPoints().get(0);
            Field field = dp.getDataType().getFields().get(0);
            //map.putDouble("date", dp.getStartTime(TimeUnit.MILLISECONDS));
            if (valType.equals("int")) {
                map.putInt("value", dp.getValue(field).asInt());
            } else {
                map.putDouble("value", dp.getValue(field).asFloat());
            }
        } else {
            int activeTime = 0;
            for (DataPoint dp : dataSet.getDataPoints()) {
                if (dp.getDataType().equals(DataType.AGGREGATE_ACTIVITY_SUMMARY)) {
                    String activity = dp.getValue(Field.FIELD_ACTIVITY).asActivity();
                    if (!activity.equals(FitnessActivities.STILL)) {
                        activeTime += dp.getValue(Field.FIELD_DURATION).asInt();  
                    }
                }
            }
            map.putInt("value", activeTime);
        }*/
        itemMap.pushMap(map);
    }
}